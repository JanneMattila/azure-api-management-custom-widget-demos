<!DOCTYPE html>
<html lang="en" class="height-fill">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dummy</title>
  <link rel="stylesheet" href="./styles/app.scss">
  <style>
    .test-section {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .test-section h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .result.success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .result.error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>

  <script type="module">
    import {askForSecrets} from "@azure/api-management-custom-widgets-tools"
    import App from "./index"

    async function fetchApimConfig() {
      try {
        const response = await fetch('/config-apim.json')
        if (response.ok) {
          const config = await response.json()
          console.log('APIM Config loaded:', config)
          return config
        }
      } catch (error) {
        console.error('Failed to fetch APIM config:', error)
      }
      return null
    }

    async function loadSecrets() {
      // Fetch APIM config for Entra ID authentication
      const apimConfig = await fetchApimConfig()
      
      const secrets = await askForSecrets("app")
      const appInstance = new App(secrets)
      
      // Initialize MSAL if config is available
      if (apimConfig) {
        await appInstance.initMsal(apimConfig)
      }
      
      if (!secrets.userId) return

      appInstance.request(`/users/${secrets.userId}`)
        .then(e => e.json())
        .then(({properties}) => {
          if (properties.email) document.getElementById("email").value = properties.email
        })
    }

    loadSecrets()
      .catch(e => console.error("Failed to retrieve secrets from the Developer Portal. The app might not work as expected!", e))
      .finally(() => {
        for (const element of document.getElementsByClassName("loading")) {
          element.classList.remove("loading")
        }
      })
  </script>
</head>
<body class="height-fill loading">

<div class="test-section">
  <h2>MSAL Authentication</h2>
  <p>Show MSAL usage in Azure API Management custom widgets.</p>
  <div id="msal-status" style="margin-bottom: 10px;">
    <strong>Status:</strong> <span id="auth-status">Not authenticated</span>
  </div>
  <div id="user-info" style="display: none; margin-bottom: 10px; padding: 10px; background-color: #e8f4f8; border-radius: 4px;">
    <strong>User:</strong> <span id="user-name"></span><br>
    <strong>Email:</strong> <span id="user-email"></span>
  </div>
  <button id="login-btn" onclick="msalLogin()">Sign In</button>
  <button id="logout-btn" onclick="msalLogout()" style="display: none;">Sign Out</button>
  <button id="test-api-btn" onclick="testAPI()" style="display: none;">Test API Call</button>
  <div id="msal-result" class="result" style="display: none;"></div>
</div>

<form id="form" method="post" target="_blank" class="flex-columns-container height-fill">
  <div class="form-group">
    <label id="values.label1" for="email" class="form-label"></label>
    <input id="email" type="email" class="form-control" name="email" placeholder="example@contoso.com" />
  </div>
  <div class="form-group height-fill flex-columns-container">
    <label id="values.label2" for="message" class="form-label"></label>
    <textarea id="message" class="form-control flex-grow" name="message"></textarea>
  </div>
  <div class="form-group">
    <button type="submit" class="button button-primary">Submit</button>
  </div>
</form>
</body>
</html>
